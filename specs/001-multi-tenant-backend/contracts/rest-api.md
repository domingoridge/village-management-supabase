# REST API Contract: Multi-Tenant Backend with RBAC

**Feature**: [spec.md](../spec.md) | **Data Model**: [data-model.md](../data-model.md)
**API Type**: PostgREST Auto-Generated + Custom RPC Functions
**Base URL**: `https://<project-ref>.supabase.co/rest/v1/`
**Authentication**: Bearer token (Supabase Auth JWT)

## Overview

This API provides access to the multi-tenant residential community management system. All endpoints enforce Row-Level Security (RLS) policies for tenant isolation. Custom JWT claims (`tenant_id`, `role_id`) determine access permissions.

**API Characteristics**:
- RESTful resource-based endpoints (auto-generated by PostgREST)
- Custom RPC functions for complex operations
- JSON request/response bodies
- Standard HTTP status codes
- JWT-based authentication with custom claims

---

## Authentication

### Headers

All requests must include:

```http
Authorization: Bearer <supabase_jwt_token>
apikey: <supabase_anon_key>
Content-Type: application/json
```

### Custom JWT Claims

The JWT token includes custom claims set by backend functions:

```json
{
  "sub": "auth_user_id",
  "email": "user@example.com",
  "app_metadata": {
    "tenant_id": "uuid-of-current-tenant",
    "role_id": "uuid-of-user-role-in-tenant"
  }
}
```

**Note**: `tenant_id` determines data isolation scope; `role_id` determines permissions.

---

## Core Resource Endpoints (PostgREST)

### Tenants

#### List Tenants (User's Accessible Tenants)

```http
GET /tenant?select=*
```

**Response**: Array of tenants user belongs to

```json
[
  {
    "id": "uuid",
    "name": "Greenfield Village",
    "slug": "greenfield-village",
    "address": "123 Main St, City",
    "subscription_plan": {
      "tier": "premium",
      "max_households": 500,
      "features": ["incidents", "permits", "analytics"]
    },
    "status": "active",
    "created_at": "2025-01-15T08:00:00Z",
    "updated_at": "2025-10-09T10:30:00Z"
  }
]
```

**RLS**: Returns only tenants where user has `tenant_user` record

---

#### Get Single Tenant

```http
GET /tenant?id=eq.<tenant_id>&select=*
```

**Response**: Single tenant object or empty array if not authorized

**RLS**: User must belong to tenant

---

### Households

#### List Households (Current Tenant)

```http
GET /household?select=*,resident(*)
```

**Query Parameters**:
- `status=eq.active` - Filter by status
- `block_lot=like.*A*` - Search by block/lot
- `order=address.asc` - Sort by address

**Response**:

```json
[
  {
    "id": "uuid",
    "tenant_id": "uuid",
    "address": "Block A, Lot 15",
    "block_lot": "A-15",
    "sticker_quota": 3,
    "status": "active",
    "metadata": {},
    "resident": [
      {
        "id": "uuid",
        "tenant_user_id": "uuid",
        "has_visiting_rights": true,
        "has_signatory_rights": true,
        "is_primary_contact": true
      }
    ],
    "created_at": "2025-03-01T00:00:00Z",
    "updated_at": "2025-10-01T12:00:00Z"
  }
]
```

**RLS**: Auto-filtered by current `tenant_id` from JWT

---

#### Create Household

```http
POST /household
Content-Type: application/json
```

**Request Body**:

```json
{
  "address": "Block B, Lot 22",
  "block_lot": "B-22",
  "sticker_quota": 2
}
```

**Response**: `201 Created`

```json
{
  "id": "uuid",
  "tenant_id": "uuid",
  "address": "Block B, Lot 22",
  "block_lot": "B-22",
  "sticker_quota": 2,
  "status": "active",
  "metadata": {},
  "created_at": "2025-10-09T14:00:00Z",
  "updated_at": "2025-10-09T14:00:00Z"
}
```

**RLS**: User must have `admin-head` or `admin-officers` role. `tenant_id` auto-set from JWT.

**Validation Errors** (400 Bad Request):

```json
{
  "code": "PGRST204",
  "message": "Validation failed",
  "details": "address: String must contain at least 1 character(s)"
}
```

---

#### Update Household

```http
PATCH /household?id=eq.<household_id>
Content-Type: application/json
```

**Request Body** (partial update):

```json
{
  "sticker_quota": 4,
  "status": "active"
}
```

**Response**: `200 OK` with updated household object

**RLS**: Admin-head/admin-officers can update any household; household-head can update only their own

---

### Tenant Users

#### List Users in Current Tenant

```http
GET /tenant_user?select=*,user_profile(*),role(*)&is_active=eq.true
```

**Response**:

```json
[
  {
    "id": "uuid",
    "tenant_id": "uuid",
    "user_profile_id": "uuid",
    "role_id": "uuid",
    "is_active": true,
    "permissions": {},
    "joined_at": "2025-01-20T00:00:00Z",
    "user_profile": {
      "id": "uuid",
      "first_name": "Juan",
      "last_name": "Dela Cruz",
      "avatar_url": "https://storage/avatars/uuid.jpg"
    },
    "role": {
      "code": "household-head",
      "name": "Household Head",
      "hierarchy_level": 4
    }
  }
]
```

**RLS**: Users can view other users in same tenant

---

### Residents

#### Add Member to Household

```http
POST /resident
Content-Type: application/json
```

**Request Body**:

```json
{
  "household_id": "uuid",
  "tenant_user_id": "uuid",
  "has_visiting_rights": true,
  "has_signatory_rights": false,
  "is_primary_contact": false
}
```

**Response**: `201 Created` with resident object

**RLS**: Household-head for their household, admin-head/admin-officers for any

**Constraint Violations** (409 Conflict):

```json
{
  "code": "23505",
  "message": "duplicate key value violates unique constraint",
  "details": "User already member of this household"
}
```

---

#### Update Member Permissions

```http
PATCH /resident?id=eq.<member_id>
Content-Type: application/json
```

**Request Body**:

```json
{
  "has_visiting_rights": false
}
```

**Response**: `200 OK`

**RLS**: Household-head can update their household members; cannot remove themselves as household-head

---

## Custom RPC Functions

### Get User's Tenants

**Endpoint**: `POST /rpc/get_user_tenants`

**Purpose**: Retrieve all tenants the current user belongs to with role information.

**Request Body**: None (uses authenticated user from JWT)

**Response**:

```json
[
  {
    "tenant_id": "uuid",
    "tenant_name": "Greenfield Village",
    "tenant_slug": "greenfield-village",
    "role_code": "admin-head",
    "role_name": "Head Administrator",
    "is_active": true,
    "joined_at": "2025-01-15T00:00:00Z"
  },
  {
    "tenant_id": "uuid",
    "tenant_name": "Sunset Heights",
    "tenant_slug": "sunset-heights",
    "role_code": "household-member",
    "role_name": "Resident",
    "is_active": true,
    "joined_at": "2025-03-01T00:00:00Z"
  }
]
```

**Use Case**: Tenant switcher UI component

---

### Switch Tenant Context

**Endpoint**: `POST /rpc/switch_tenant_context`

**Purpose**: Change the user's active tenant context (updates JWT claims).

**Request Body**:

```json
{
  "target_tenant_id": "uuid"
}
```

**Response**: `200 OK`

```json
{
  "success": true,
  "tenant_id": "uuid",
  "role_id": "uuid",
  "role_code": "admin-head",
  "message": "Tenant context switched successfully"
}
```

**Client Action**: After successful response, client must refresh JWT token to pick up new claims.

**Error Cases**:

- **403 Forbidden**: User does not belong to target tenant

```json
{
  "error": "User not authorized for tenant",
  "details": "User is not a member of the specified tenant"
}
```

- **404 Not Found**: Tenant does not exist

---

### Assign User to Tenant

**Endpoint**: `POST /rpc/assign_user_to_tenant`

**Purpose**: Add a user to a tenant with a specific role (admin function).

**Request Body**:

```json
{
  "target_tenant_id": "uuid",
  "target_user_profile_id": "uuid",
  "role_code": "household-head",
  "permissions": {
    "can_approve_permits": true
  }
}
```

**Response**: `201 Created`

```json
{
  "tenant_user_id": "uuid",
  "tenant_id": "uuid",
  "user_profile_id": "uuid",
  "role_id": "uuid",
  "is_active": true,
  "permissions": {
    "can_approve_permits": true
  },
  "joined_at": "2025-10-09T15:00:00Z"
}
```

**Authorization**: User must have `admin-head` role in target tenant or be `superadmin`.

**Error Cases**:

- **409 Conflict**: User already assigned to tenant

```json
{
  "error": "User already member of tenant",
  "details": "Use update endpoint to modify role or permissions"
}
```

---

### Check User Permission

**Endpoint**: `POST /rpc/check_user_permission`

**Purpose**: Validate if current user has a specific permission in current tenant context.

**Request Body**:

```json
{
  "permission_key": "manage_households"
}
```

**Response**: `200 OK`

```json
{
  "has_permission": true,
  "role_code": "admin-officers",
  "source": "role_default"
}
```

**Response Fields**:
- `has_permission`: Boolean result
- `role_code`: User's current role
- `source`: `"role_default"` or `"permission_override"`

**Use Case**: Frontend permission checks before showing UI elements or enabling actions.

---

### Validate Current Session

**Endpoint**: `POST /rpc/validate_current_session`

**Purpose**: Verify user's session is still valid (checks `tenant_user.is_active`).

**Request Body**: None

**Response**: `200 OK`

```json
{
  "valid": true,
  "tenant_id": "uuid",
  "role_id": "uuid",
  "is_active": true
}
```

**Error Case** (User removed from tenant):

```json
{
  "valid": false,
  "error": "Session invalidated",
  "details": "User has been removed from tenant"
}
```

**Client Action**: If `valid: false`, force logout and redirect to login.

**Use Case**: Periodic session validation (e.g., every 5 minutes) to enforce 5-second session invalidation requirement.

---

## Error Responses

### Standard HTTP Status Codes

- **200 OK**: Successful request
- **201 Created**: Resource created successfully
- **204 No Content**: Successful delete or update with no response body
- **400 Bad Request**: Validation error or malformed request
- **401 Unauthorized**: Missing or invalid JWT token
- **403 Forbidden**: User lacks permission for action
- **404 Not Found**: Resource not found or RLS filtered it out
- **409 Conflict**: Constraint violation (unique, foreign key)
- **500 Internal Server Error**: Server-side error

### Error Response Format

```json
{
  "code": "PGRST116",
  "message": "Human-readable error message",
  "details": "Additional context or field-specific errors",
  "hint": "Suggestion for fixing the error"
}
```

### Common Error Codes

- `PGRST116`: JWT token expired or invalid
- `PGRST204`: Query validation failed
- `23503`: Foreign key violation
- `23505`: Unique constraint violation
- `42501`: Insufficient permissions (RLS policy denied)

---

## Pagination

PostgREST supports range-based pagination:

**Request**:

```http
GET /household?select=*&order=created_at.desc
Range: 0-9
```

**Response Headers**:

```http
Content-Range: 0-9/45
```

**Response**: Array of 10 households (0-indexed)

**Next Page**:

```http
Range: 10-19
```

---

## Filtering & Querying

PostgREST provides rich query capabilities:

### Equality

```http
GET /household?status=eq.active
```

### Comparison

```http
GET /household?sticker_quota=gte.3
```

### Pattern Matching

```http
GET /household?address=like.*Block%20A*
```

### Logical Operators

```http
GET /household?or=(status.eq.active,status.eq.suspended)
```

### Nested Resources

```http
GET /household?select=*,resident(tenant_user_id,has_visiting_rights)
```

---

## Rate Limiting

- **Anonymous requests**: 100 requests/minute per IP
- **Authenticated requests**: 500 requests/minute per user
- **RPC functions**: 60 requests/minute per function

**Rate Limit Headers**:

```http
X-RateLimit-Limit: 500
X-RateLimit-Remaining: 487
X-RateLimit-Reset: 1633024800
```

**Rate Limit Exceeded** (429 Too Many Requests):

```json
{
  "error": "Rate limit exceeded",
  "retry_after": 42
}
```

---

## API Versioning

- **Current Version**: `v1` (specified in base URL)
- **Version Strategy**: URL-based versioning
- **Deprecation Policy**: Minimum 2 major releases notice before removal
- **Breaking Changes**: New major version (e.g., `v2`)

**Deprecated Endpoint Example**:

```http
HTTP/1.1 200 OK
Deprecation: true
Sunset: Fri, 11 Nov 2025 23:59:59 GMT
Link: </rest/v2/tenant>; rel="successor-version"
```

---

## Security Considerations

### RLS Enforcement

All queries are automatically filtered by:
1. **Tenant isolation**: `tenant_id = auth.get_current_tenant_id()`
2. **Role permissions**: Based on `role_id` from JWT
3. **User ownership**: Some resources filtered by `auth.uid()`

### Data Leakage Prevention

- **404 vs 403**: All unauthorized access returns `404` (not `403`) to prevent tenant enumeration
- **ID obfuscation**: UUIDs used for all IDs (not sequential integers)
- **Error messages**: No sensitive data in error responses

### CORS

Configured per environment:
- **Local**: `http://localhost:3000`
- **Staging**: `https://staging.app.com`
- **Production**: `https://app.com`

---

## OpenAPI Specification

Full OpenAPI 3.0 spec available at:

```
GET /rest/v1/
Accept: application/openapi+json
```

**Note**: PostgREST auto-generates OpenAPI spec from database schema. Custom RPC functions documented manually.

---

## Next Steps

1. ✅ REST API contracts defined for core resources and RPC functions
2. ⏭️ Generate quickstart.md with example API usage
3. ⏭️ Implement Supabase migrations to create database schema
4. ⏭️ Implement custom RPC functions in SQL

**API Contract Status**: ✅ COMPLETE
